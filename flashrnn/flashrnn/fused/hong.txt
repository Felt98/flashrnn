# 基本配置
FLASHRNN_FORWARD_CLIPVAL = 0.0
FLASHRNN_HIDDEN_DIM = 384
FLASHRNN_NUM_HEADS = 12
head_dim = 32

# Shared Memory Padding
FLASHRNN_BACKWARD_SHARED_MEMORY_PADDING = 8
FLASHRNN_FORWARD_SHARED_MEMORY_PADDING = 8

# Warp Tiling Dimensions - Forward
FLASHRNN_FORWARD_WARP_TILING_DIM_HIDDEN = 16
FLASHRNN_FORWARD_WARP_TILING_DIM_BATCH = 16
FLASHRNN_FORWARD_WARP_TILING_DIM_GATE = 16

# Warp Tiling Dimensions - Backward
FLASHRNN_BACKWARD_WARP_TILING_DIM_GATE = 16
FLASHRNN_BACKWARD_WARP_TILING_DIM_BATCH = 16
FLASHRNN_BACKWARD_WARP_TILING_DIM_HIDDEN = 16

# Multihead Tiling Count
FLASHRNN_FORWARD_MULTIHEAD_TILING_COUNT = 12
FLASHRNN_BACKWARD_MULTIHEAD_TILING_COUNT = 12

# Recurrent Tiling Count
FLASHRNN_FORWARD_RECURRENT_TILING_COUNT_GATE = 8     // 单个head中，4D方向有8个tile(block) = blockDim.x
FLASHRNN_FORWARD_RECURRENT_TILING_COUNT_HIDDEN = 1   // 单个head中，D(H)方向1个tile(block)
FLASHRNN_BACKWARD_RECURRENT_TILING_COUNT_HIDDEN = 2
FLASHRNN_BACKWARD_RECURRENT_TILING_COUNT_GATE = 1

# Block Tiling Count (Batch)
FLASHRNN_FORWARD_BLOCK_TILING_COUNT_BATCH = 1
FLASHRNN_BACKWARD_BLOCK_TILING_COUNT_BATCH = 1

# Warp Looping Count
FLASHRNN_FORWARD_WARP_LOOPING_COUNT_BATCH = 1
FLASHRNN_BACKWARD_WARP_LOOPING_COUNT_BATCH = 1
FLASHRNN_FORWARD_WARP_LOOPING_COUNT_GATE = 1
FLASHRNN_BACKWARD_WARP_LOOPING_COUNT_HIDDEN = 1

# Warp Tiling Count
FLASHRNN_FORWARD_WARP_TILING_COUNT_BATCH = 1
FLASHRNN_BACKWARD_WARP_TILING_COUNT_BATCH = 1
FLASHRNN_FORWARD_WARP_TILING_COUNT_HIDDEN = 2   // D(H)方向上 每个block有2个warp
FLASHRNN_BACKWARD_WARP_TILING_COUNT_GATE = 8

# Recurrent Cached Flags
FLASHRNN_BACKWARD_WARP_RECURRENT_CACHED_GATE = 1
FLASHRNN_FORWARD_WARP_RECURRENT_CACHED_HIDDEN = 1

hidden_grid_dim = 1
hidden_block_idx = 0
multihead_idx = headId * D
batch_idx = 0
block_batch_idx = 0
BatchIterations =1 
head_dim_per_block_shared=0
wtch_idx = 0 | 1     // D(H)方向上的warp编号
wlcg_idx = 0
state_offset = 0
state_offset_loc = 0
midx = 0 | 16
((threadIdx.x % (blockDim.x / FWTCH)) / warpSize) = 0
gate_warp_local_idx =0

uint R_offset = FLASHRNN_NUM_GATES_R * multihead_idx * head_dim +
                                    (blockIdx.x * FLASHRNN_NUM_GATES_R * head_dim / FRTCG) *head_dim 
                                    +wtch_idx * (head_dim / FRTCH / FWTCH)
    // 注意R是col_major，要在block那里*head_dim 
uint states_offset = local_batch_idx * FWTDB * FLASHRNN_HIDDEN_SIZE + multihead_idx + state_offset_loc + midx